<UserControl x:Class="EZRClone.Views.ConfigView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:EZRClone.ViewModels"
             xmlns:conv="clr-namespace:EZRClone.Converters"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance vm:ConfigViewModel}"
             Loaded="OnLoaded"
             Background="{DynamicResource BackgroundBrush}">
    <UserControl.Resources>
        <conv:InverseBoolToVisConverter x:Key="InverseBoolToVis" />
    </UserControl.Resources>

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Config path banner -->
        <Border Grid.Row="0" Background="{DynamicResource SurfaceBrush}" CornerRadius="3" Padding="12,8" Margin="0,0,0,12">
            <TextBlock Foreground="{DynamicResource ForegroundBrush}">
                <Run Text="Config: " FontWeight="SemiBold" />
                <Run Text="{Binding ConfigFilePath, Mode=OneWay}" />
            </TextBlock>
        </Border>

        <!-- Toolbar -->
        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,12">
            <TextBlock Text="Remotes" FontSize="18" FontWeight="SemiBold"
                       Foreground="{DynamicResource ForegroundBrush}"
                       VerticalAlignment="Center" Margin="0,0,16,0" />
            <Button Content="+ New" Style="{DynamicResource AccentButton}"
                    Command="{Binding NewRemoteCommand}" Margin="0,0,8,0" />
            <Button Content="Refresh"
                    Command="{Binding LoadRemotesCommand}" />
        </StackPanel>

        <!-- Master-Detail -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250" />
                <ColumnDefinition Width="12" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!-- Remote list -->
            <Border Grid.Column="0" Background="{DynamicResource SurfaceBrush}" CornerRadius="3">
                <ListView ItemsSource="{Binding Remotes}"
                          SelectedItem="{Binding SelectedRemote}"
                          Background="Transparent"
                          BorderThickness="0">
                    <ListView.View>
                        <GridView>
                            <GridViewColumn Header="Name" Width="140"
                                            DisplayMemberBinding="{Binding Name}" />
                            <GridViewColumn Header="Type" Width="90"
                                            DisplayMemberBinding="{Binding Type}" />
                        </GridView>
                    </ListView.View>
                </ListView>
            </Border>

            <!-- Detail panel -->
            <Border Grid.Column="2" Background="{DynamicResource SurfaceBrush}" CornerRadius="3" Padding="16">
                <Grid>
                    <!-- Read-only detail view -->
                    <StackPanel Visibility="{Binding IsEditing, Converter={StaticResource InverseBoolToVis}}">
                        <TextBlock Text="{Binding SelectedRemote.Name}"
                                   FontSize="18" FontWeight="SemiBold"
                                   Foreground="{DynamicResource ForegroundBrush}"
                                   Margin="0,0,0,12" />

                        <Grid Margin="0,0,0,4">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="150" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="Type:" Foreground="{DynamicResource ForegroundSecondaryBrush}" FontWeight="SemiBold" />
                            <TextBlock Grid.Column="1" Text="{Binding SelectedRemote.Type}" />
                        </Grid>

                        <ItemsControl ItemsSource="{Binding SelectedRemote.Properties}" Margin="0,4,0,16">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="0,2">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="150" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="{Binding Key}" Foreground="{DynamicResource ForegroundSecondaryBrush}" FontWeight="SemiBold" />
                                        <TextBlock Grid.Column="1" Text="{Binding Value}" />
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <StackPanel Orientation="Horizontal">
                            <Button Content="Edit" Style="{DynamicResource AccentButton}"
                                    Command="{Binding EditCommand}" Margin="0,0,8,0" />
                            <Button Content="Delete" Style="{DynamicResource DangerButton}"
                                    Command="{Binding DeleteCommand}" Margin="0,0,8,0" />
                            <Button Content="Test"
                                    Command="{Binding TestConnectionCommand}" />
                        </StackPanel>
                    </StackPanel>

                    <!-- Inline edit view -->
                    <StackPanel Visibility="{Binding IsEditing, Converter={StaticResource BoolToVis}}">
                        <TextBlock FontSize="16" FontWeight="SemiBold"
                                   Foreground="{DynamicResource ForegroundBrush}" Margin="0,0,0,12">
                            <Run Text="{Binding IsNewRemote, Mode=OneWay, StringFormat='{}New Remote'}"
                                 x:Name="EditHeader" />
                        </TextBlock>

                        <TextBlock Text="Name:" Foreground="{DynamicResource ForegroundSecondaryBrush}" Margin="0,0,0,4" />
                        <TextBox Text="{Binding EditName, UpdateSourceTrigger=PropertyChanged}"
                                 Margin="0,0,0,8" Padding="6,4" />

                        <TextBlock Text="Type:" Foreground="{DynamicResource ForegroundSecondaryBrush}" Margin="0,0,0,4" />
                        <ComboBox ItemsSource="{Binding BackendTypes}"
                                  SelectedValuePath="TypeName"
                                  DisplayMemberPath="DisplayName"
                                  SelectedValue="{Binding EditType}"
                                  Margin="0,0,0,12" Padding="6,4" />

                        <TextBlock Text="Properties:" Foreground="{DynamicResource ForegroundSecondaryBrush}"
                                   FontWeight="SemiBold" Margin="0,0,0,8" />

                        <ItemsControl ItemsSource="{Binding EditProperties}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="0,0,0,4">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="150" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="30" />
                                        </Grid.ColumnDefinitions>
                                        <TextBox Text="{Binding Key, UpdateSourceTrigger=PropertyChanged}"
                                                 Padding="4,3" Margin="0,0,6,0" />
                                        <TextBox Grid.Column="1"
                                                 Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}"
                                                 Padding="4,3" />
                                        <Button Grid.Column="2" Content="X"
                                                Command="{Binding DataContext.RemovePropertyCommand,
                                                    RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}"
                                                Background="Transparent" Foreground="#C42B1C"
                                                BorderThickness="0" Cursor="Hand"
                                                VerticalAlignment="Center" HorizontalAlignment="Center" />
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <Button Content="+ Add Property"
                                Command="{Binding AddPropertyCommand}"
                                HorizontalAlignment="Left" Margin="0,4,0,16" />

                        <StackPanel Orientation="Horizontal">
                            <Button Content="Save" Style="{DynamicResource AccentButton}"
                                    Command="{Binding SaveCommand}" Margin="0,0,8,0" />
                            <Button Content="Cancel"
                                    Command="{Binding CancelEditCommand}" />
                        </StackPanel>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>

        <!-- Status bar -->
        <Border Grid.Row="3" Margin="0,8,0,0">
            <TextBlock Text="{Binding StatusMessage}" Foreground="{DynamicResource ForegroundSecondaryBrush}" FontSize="12" />
        </Border>
    </Grid>
</UserControl>
